<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salah Connect Pro | Eternal Logic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --emerald: #10b981; --dark: #050608; }
        body { background: var(--dark); color: #f8fafc; font-family: 'Plus Jakarta Sans', sans-serif; overflow-x: hidden; }
        .glass { background: rgba(255, 255, 255, 0.02); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); transition: 0.3s; }
        .glass:hover { border-color: var(--emerald); transform: translateY(-4px); }
        .modal-bg { background: rgba(0, 0, 0, 0.95); backdrop-filter: blur(8px); }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="p-6 border-b border-white/5 sticky top-0 bg-black/80 backdrop-blur-md z-50">
        <div class="max-w-5xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-emerald-600 rounded-xl flex items-center justify-center font-black text-xl italic shadow-lg shadow-emerald-500/20 text-white">S</div>
                <h1 class="text-xl font-extrabold tracking-tighter uppercase italic">Salah<span class="text-emerald-500 not-italic">Connect</span></h1>
            </div>
            <button onclick="toggleModal()" class="bg-emerald-600 hover:bg-emerald-500 px-4 py-2 rounded-lg text-[10px] font-bold uppercase tracking-widest transition shadow-lg shadow-emerald-600/20 text-white">
                + Setup Masjid
            </button>
        </div>
    </header>

    <main class="p-6 max-w-5xl mx-auto w-full flex-grow">
        <div id="grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            </div>
    </main>

    <div id="setupModal" class="fixed inset-0 modal-bg hidden z-[100] flex items-center justify-center p-4">
        <div class="glass max-w-md w-full p-8 rounded-[2.5rem] border-emerald-500/30">
            <h3 class="text-xl font-bold mb-1 text-emerald-500">Eternal Setup</h3>
            <p class="text-gray-500 text-[10px] uppercase tracking-widest mb-6">Set today's times to lock the pattern</p>
            
            <form id="setupForm" class="space-y-4">
                <input type="text" id="mName" placeholder="Masjid Name" class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl outline-none focus:border-emerald-500 transition" required>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-[9px] text-gray-500 font-bold uppercase ml-2">Fajr Jama'at</label>
                        <input type="time" id="fajrJ" class="w-full bg-white/5 border border-white/10 p-3 rounded-xl outline-none" required>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[9px] text-gray-500 font-bold uppercase ml-2">Zohr (Fixed)</label>
                        <input type="time" id="zohrJ" class="w-full bg-white/5 border border-white/10 p-3 rounded-xl outline-none" required>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[9px] text-gray-500 font-bold uppercase ml-2">Asr Jama'at</label>
                        <input type="time" id="asrJ" class="w-full bg-white/5 border border-white/10 p-3 rounded-xl outline-none" required>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[9px] text-gray-500 font-bold uppercase ml-2">Isha Jama'at</label>
                        <input type="time" id="ishaJ" class="w-full bg-white/5 border border-white/10 p-3 rounded-xl outline-none" required>
                    </div>
                </div>

                <div class="flex gap-4 mt-8">
                    <button type="button" onclick="toggleModal()" class="flex-1 py-4 text-[10px] font-bold uppercase text-gray-500">Cancel</button>
                    <button type="submit" class="flex-1 py-4 bg-emerald-600 rounded-2xl text-[10px] font-bold uppercase text-white">Lock Logic</button>
                </div>
            </form>
        </div>
    </div>

    <footer class="p-10 text-center border-t border-white/5 text-[10px] text-gray-700 tracking-[0.4em] uppercase">
        © 2026 Developed by Mujtaba Mazroof
    </footer>

    <script>
        let prayerTimes = {};

        // --- 1. THE LOGIC FOR LOGIC ENGINE ---
        function detectAndCalc(salah, userJamaat, currentAthan) {
            let userT = toMin(userJamaat);
            let athanT = toMin(currentAthan);
            let diff = userT - athanT;

            // Pattern Detection: 15, 30, or 45 min brackets
            let baseInterval = 15;
            if (diff >= 45 && diff < 60) baseInterval = 45;
            else if (diff >= 30 && diff < 45) baseInterval = 30;
            else if (diff >= 15 && diff < 30) baseInterval = 15;

            // Eternal Formula
            let rem = athanT % baseInterval;
            return (rem === 0) ? athanT + baseInterval : (Math.ceil(athanT / baseInterval) * baseInterval) + baseInterval;
        }

        function toMin(str) {
            let [h, m] = str.split(':').map(Number);
            return h * 60 + m;
        }

        function fmt(min) {
            let h = Math.floor(min / 60) % 24;
            let m = min % 60;
            return `${h % 12 || 12}:${m.toString().padStart(2, '0')} ${h >= 12 ? 'PM' : 'AM'}`;
        }

        function toggleModal() { document.getElementById('setupModal').classList.toggle('hidden'); }

        // --- 2. DATA STORAGE ---
        document.getElementById('setupForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const masjid = {
                name: document.getElementById('mName').value,
                fajr: document.getElementById('fajrJ').value,
                zohr: document.getElementById('zohrJ').value,
                asr: document.getElementById('asrJ').value,
                isha: document.getElementById('ishaJ').value
            };
            let masjids = JSON.parse(localStorage.getItem('savedMasjids') || '[]');
            masjids.push(masjid);
            localStorage.setItem('savedMasjids', JSON.stringify(masjids));
            render();
            toggleModal();
        });

        function removeMasjid(index) {
            let masjids = JSON.parse(localStorage.getItem('savedMasjids') || '[]');
            masjids.splice(index, 1);
            localStorage.setItem('savedMasjids', JSON.stringify(masjids));
            render();
        }

        // --- 3. RENDER ENGINE ---
        async function init() {
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const res = await fetch(`https://api.aladhan.com/v1/timings?latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&method=1`).then(r => r.json());
                prayerTimes = res.data.timings;
                render();
            });
        }

        function render() {
            const grid = document.getElementById('grid');
            const stored = JSON.parse(localStorage.getItem('savedMasjids') || '[]');
            grid.innerHTML = '';
            
            if(stored.length === 0) {
                grid.innerHTML = `<div class="col-span-full py-20 text-center text-gray-600 italic">No masjids configured. Setup your first masjid to start tracking.</div>`;
                return;
            }

            stored.forEach((m, idx) => {
                grid.innerHTML += `
                    <div class="glass p-8 rounded-[2.5rem] relative">
                        <button onclick="removeMasjid(${idx})" class="absolute top-6 right-6 text-gray-700 hover:text-red-500 text-xs">✕</button>
                        <h3 class="text-xl font-bold text-emerald-500 mb-6 truncate pr-6">${m.name}</h3>
                        <div class="space-y-4 text-sm">
                            <div class="flex justify-between border-b border-white/5 pb-2"><span class="text-gray-500">Fajr</span><b>${fmt(detectAndCalc('Fajr', m.fajr, prayerTimes.Sunrise))}</b></div>
                            <div class="flex justify-between border-b border-white/5 pb-2"><span class="text-emerald-500/50">Zohr (Fix)</span><b>${fmt(toMin(m.zohr))}</b></div>
                            <div class="flex justify-between border-b border-white/5 pb-2"><span class="text-gray-500">Asr</span><b>${fmt(detectAndCalc('Asr', m.asr, prayerTimes.Asr))}</b></div>
                            <div class="flex justify-between border-b border-white/5 pb-2"><span class="text-gray-500">Maghrib</span><b>${fmt(toMin(prayerTimes.Maghrib)+7)}</b></div>
                            <div class="flex justify-between border-b border-white/5 pb-2"><span class="text-gray-500">Isha</span><b>${fmt(detectAndCalc('Isha', m.isha, prayerTimes.Isha))}</b></div>
                        </div>
                    </div>`;
            });
        }

        init();
    </script>
</body>
</html>
