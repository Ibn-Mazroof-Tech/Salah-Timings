<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salah Connect Pro | Delhi NCR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --emerald: #10b981; --dark: #050608; }
        body { background: var(--dark); color: #f8fafc; font-family: 'Plus Jakarta Sans', sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.02); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.08); transition: 0.3s; }
        .glass:hover { border-color: var(--emerald); transform: translateY(-3px); }
        .shimmer { background: linear-gradient(90deg, transparent, rgba(16, 185, 129, 0.05), transparent); background-size: 200% 100%; animation: shim 2s infinite; }
        @keyframes shim { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
    </style>
</head>
<body class="min-h-screen">

    <header class="p-6 border-b border-white/5 sticky top-0 bg-black/80 backdrop-blur-md z-50">
        <div class="max-w-5xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-emerald-600 rounded-xl flex items-center justify-center font-black text-xl italic shadow-lg shadow-emerald-500/20">S</div>
                <h1 class="text-xl font-extrabold tracking-tighter uppercase italic">Salah<span class="text-emerald-500 not-italic">Connect</span></h1>
            </div>
            <div id="status" class="text-[10px] font-bold px-3 py-1 bg-emerald-500/10 text-emerald-500 border border-emerald-500/20 rounded-full tracking-[0.2em]">SCANNING DELHI NCR...</div>
        </div>
    </header>

    <main class="p-6 max-w-5xl mx-auto">
        <div id="grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="glass rounded-3xl p-8 h-64 shimmer"></div>
            <div class="glass rounded-3xl p-8 h-64 shimmer"></div>
            <div class="glass rounded-3xl p-8 h-64 shimmer"></div>
        </div>
    </main>

    <script>
        // --- LOGIC: FAJR, ASR, ISHA (Multiple of 5/15/29) ---
        function getJamaat(salah, start) {
            let [h, m] = start.split(':').map(Number);
            let t = h * 60 + m;
            let j;

            if (salah === 'Fajr') {
                let n5 = Math.ceil(t / 5) * 5;
                j = (n5 === t + 1) ? (n5 - 5) - 25 : n5 - 25;
            } else if (salah === 'Asr' || salah === 'Isha') {
                let rem = t % 15;
                j = (rem === 0) ? t + 15 : (Math.ceil(t / 15) * 15) + 15;
            } else if (salah === 'Maghrib') {
                j = t + 7;
            } else { j = t; } // Zohr logic
            return j;
        }

        function fmt(min) {
            let h = Math.floor(min / 60) % 24;
            let m = min % 60;
            return `${h % 12 || 12}:${m.toString().padStart(2, '0')} ${h >= 12 ? 'PM' : 'AM'}`;
        }

        async function init() {
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const { latitude, longitude } = pos.coords;
                
                // Optimized Overpass Query (Nodes + Ways)
                const query = `[out:json][timeout:30];(node["amenity"="place_of_worship"]["religion"="muslim"](around:50000,${latitude},${longitude});way["amenity"="place_of_worship"]["religion"="muslim"](around:50000,${latitude},${longitude}););out center;`;
                const mirrors = [
                    "https://overpass-api.de/api/interpreter",
                    "https://overpass.kumi.systems/api/interpreter",
                    "https://overpass.nchc.org.tw/api/interpreter"
                ];

                let mapData = null;
                for (let api of mirrors) {
                    try {
                        const res = await fetch(`${api}?data=${encodeURIComponent(query)}`);
                        if (res.ok) { mapData = await res.json(); break; }
                    } catch (e) { continue; }
                }

                const prayerRes = await fetch(`https://api.aladhan.com/v1/timings?latitude=${latitude}&longitude=${longitude}&method=1`).then(r => r.json());
                const t = prayerRes.data.timings;
                const grid = document.getElementById('grid');
                grid.innerHTML = '';

                if (!mapData || mapData.elements.length === 0) {
                    grid.innerHTML = `<div class="col-span-full py-20 text-center text-gray-500">No masjids found. This usually happens on local networks. Once deployed to Vercel, this will load correctly.</div>`;
                    return;
                }

                mapData.elements.forEach(m => {
                    const name = m.tags.name || m.tags["name:en"] || "Local Masjid";
                    const schedule = [
                        { l: 'Fajr', t: t.Sunrise },
                        { l: 'Zohr', t: "13:30" },
                        { l: 'Asr', t: t.Asr },
                        { l: 'Maghrib', t: t.Maghrib },
                        { l: 'Isha', t: t.Isha }
                    ];

                    let html = `<div class="glass rounded-[2rem] p-8 flex flex-col justify-between">
                        <h3 class="text-xl font-bold text-emerald-500 mb-6 truncate" title="${name}">${name}</h3>
                        <div class="space-y-4">`;
                    
                    schedule.forEach(s => {
                        const jTime = getJamaat(s.l, s.t);
                        html += `
                            <div class="flex justify-between items-center">
                                <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">${s.l}</span>
                                <span class="text-md font-mono font-bold">${fmt(jTime)}</span>
                            </div>`;
                    });

                    html += `</div></div>`;
                    grid.innerHTML += html;
                });
                document.getElementById('status').innerText = "RADAR: ONLINE";
            }, (err) => {
                document.getElementById('status').innerText = "GPS DENIED";
                document.getElementById('grid').innerHTML = `<div class="col-span-full py-20 text-center">Please enable GPS to see nearby masjids.</div>`;
            });
        }
        init();
    </script>
</body>
</html>
